<!DOCTYPE html>
<html>
<head>
  
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.6/purify.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js" integrity="sha512-V/C9Axb8EEL4ix79ERIJmpRd6Mp1rWVSxa2PIBCdCxqhEsfCBWp/R0xJ4U495czhcuDWrGOFYo8+QI3lJ9DK5g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>

 <link href="/static/css/styles.css" rel="stylesheet">
 <script src="/static/js/scripts.js"></script>
    <title>X-ray Bone Fracture Detection</title>

       
    </style> 
</head>
<body>
    <section class="page-section" id="result">
        <div class="container px-4 px-lg-5">
            <h2 class="text-center mt-0">Results</h2>
            <hr class="divider" />
            <div class="row gx-4 gx-lg-5">
                <div class="col-lg-3 col-md-6 text-center">
                    <div class="mt-5">
                        <div class="mb-2"><i class="fa-solid fa-bone  fs-1 text-primary"></i>                                </div>
                        <h3 class="h4 mb-2">Picture uploaded</h3>
                          <div class="card" style="width: 18rem;">
                            <img src="{{ image_path }}" class="img-fluid" alt="Uploaded Image" data-bs-toggle="modal" data-bs-target="#imageModal">

                            <div class="card-body">
                              <p class="card-text">This is the uploaded X-RAY  image, click for a bigger vison of it .</p>
                            </div>
                          </div>
                          
                          <!-- Modal -->
                          <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" style=" text-align: center;    "  id="imageModalLabel">X-RAY</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <img src="{{ image_path }}" style="width:500px; height: 500px;" class="img-fluid" alt="Descriptive Alt Text">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 text-center">
                    <div class="mt-5">
                        <div style="height:42px ;" class="mb-2"><i class="bi bi-question-circle  fs-1 text-primary"></i></div>
                        <h3   class="h4 mb-2">Prediction results </h3>
                        <div style="display: flex; justify-content: center; width: 100%;">
                          <h4 style="margin-top:50% ; color: {{ prediction.lower() == 'fractured' and 'red' or 'green' if prediction is defined else 'black' }};">
                              {{ prediction if prediction is defined else "No prediction made yet" }}
                          </h4>
                      </div>
                      
                        
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 text-center">
                    <div class="mt-5">
                        <div class="mb-2"><i class="fa-solid fa-chart-pie fs-1 text-primary"></i></div>
                        <h3 class="h4 mb-2">Prediction purcentage</h3>
                        <div id="piechart">
                          
                        </div>

                       
                        <div class="row">
                            <div class="col-md-6" style="   height: 350px ; width: 350px;"> <!-- Height control -->
                             
                             
                                <canvas width="100%" height="100%" id="probChart"></canvas>
                      

                            
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 text-center">
                    <div class="mt-5">
                        <div class="mb-2"><i class="fs-1 text-primary fa-solid fa-cogs"></i></div>
                        <h3 class="h4 mb-2">Secure a back-up </h3>
                        <button onclick="sendEmail()" class="btn btn-primary btn-xl" ><i class="fa-solid fa-envelope"></i> Send via email</button>
                        <br> <br> 
                        <!-- Add this inside your result_content.html where appropriate -->
                        <iframe id="hidden-iframe" style="display:none;" src=""></iframe>
                        <button id="download-pdf-button" class="btn btn-primary btn-xl">
                            <i class="fa-solid fa-print"></i> Download / Print
                        </button>
                        <br> <br> 
                        <button onclick="resetSession()"  class="btn btn-primary btn-xl">
                            <i class=" fa-solid fa-arrow-rotate-right"></i> Reset
                        </button>

                    </div>
                </div>
            </div>
        </div>
    </section>
   
   <script> 
function resetSession() {
    // Redirect to the logout route
    window.location.href = '/logout';
}
document.getElementById('download-pdf-button').addEventListener('click', function() {
    var canvas = document.getElementById('probChart1');
    if (canvas) {
        // Convert the canvas to a data URL
        var canvasImg = canvas.toDataURL("image/png");

        // Create an img element to replace the canvas
        var img = document.createElement('img');
        img.style.width = '350px';
        img.style.height = '350px';
        img.src = canvasImg;

        // Replace the canvas with the new img
        canvas.parentNode.replaceChild(img, canvas);
    }

    var iframe = document.getElementById('hidden-iframe');
    iframe.onload = function() {
        console.log("Iframe loaded, ready to print.");
        setTimeout(() => {
            iframe.contentWindow.print();
        }); // Adjust delay as necessary
    };
    iframe.src = 'pdfgen';  // Ensure this is the correct path
});
function sendEmail() {
    fetch('/send_email', { method: 'POST' })  // Change to the correct route
    .then(response => response.text())
    .then(data => alert(data))
    .catch(error => console.error('Error:', error));
}

// document.getElementById('download-pdf-button').addEventListener('click', function() {
//     // Trigger the print dialog
//     window.print();
// });


document.addEventListener('DOMContentLoaded', function() {
        var ctx1 = document.getElementById('probChart').getContext('2d');
        var prob_fractured = {{ prob_fractured }}.toFixed(2);
        var prob_not_fractured = {{ prob_not_fractured }}.toFixed(2);
 

        var data = {
            labels: ['Fractured (' + prob_fractured + '%)', 'Not Fractured (' + prob_not_fractured + '%)'],
            datasets: [{
                data: [prob_fractured, prob_not_fractured], 
                backgroundColor: ['#004c6d', '#ff8c00'],
                hoverBackgroundColor: ['rgba(0, 76, 109, 0.7)', 'rgba(255, 140, 0, 0.7)'] 
            }]
        };

        var options = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 40,
                        padding: 20,
                        pointStyle: 'circle',
                        usePointStyle: true,
                        font: {
                            weight: 'bold',
                            size: 15
                        }
                    }
                }
            }
        };

        new Chart(ctx1, {
            type: 'doughnut',
            data: data,
            options: options
        });
    });
     
    

    
     
      </script>
      
      
</body>
</html>
